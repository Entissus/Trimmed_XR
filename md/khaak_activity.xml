<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!--
<replace sel="//cue[@name='SpawnActiveKhaak']">
<replace sel="/mdscript/cues/cue[@name='Manager']/cues/cue[@name='SpawnActiveKhaak']">
-->
<replace sel="//cue[@name='SpawnActiveKhaak']">
	<cue name="SpawnActiveKhaak" instantiate="true" namespace="this">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <actions>
            <set_value name="$ActivateTime" exact="4s"/>
            <do_if value="@event.param.{4}">
			  <do_any>
                <set_value name="$Class" exact="class.ship_l" weight="2"/>
                <set_value name="$Class" exact="class.ship_m" weight="10"/>
                <set_value name="$Class" exact="class.ship_s" weight="5"/>
              </do_any>
			  <!--
              <set_value name="$Class" exact="class.ship_l"/>
			  -->
            </do_if>
            <do_else>
              <do_any>
                <set_value name="$Class" exact="class.ship_l" weight="1"/>
                <set_value name="$Class" exact="class.ship_m" weight="10"/>
                <set_value name="$Class" exact="class.ship_s" weight="5"/>
              </do_any>
            </do_else>
            <create_ship name="$Ship" sector="event.param.{1}">
              <select faction="faction.khaak" size="$Class"/>
              <owner exact="faction.khaak"/>
              <pilot actor="null"/>
              <position value="event.param.{2}"/>
            </create_ship>
            <do_if value="$Ship.exists">
              <debug_text text="'Created Khaak ship ' + $Ship + ' ' + $Ship.knownname + ' in sector ' + event.param.{1}.knownname" chance="Manager.$DebugChance"/>

              <find_object_component name="$Engines" multiple="true" object="$Ship" class="class.engine"/>
              <do_for_each name="$Engine" in="$Engines">
                <set_object_hacked object="$Engine" duration="$ActivateTime"/>
              </do_for_each>

              <set_value name="$ShipGroup" exact="null"/>
              <do_if value="@event.param.{3}.exists">
                <do_if value="@event.param.{5}">
                  <!--Is a defensive spawn-->
                  <set_value name="$ShipGroup" exact="@Manager.$DefenceShipGroupTable.{event.param.{3}}"/>
                </do_if>
                <do_elseif value="Manager.$Outposts.indexof.{event.param.{3}}">
                  <set_value name="$ShipGroup" exact="@Manager.$OutpostShipGroupTable.{event.param.{3}}"/>
                </do_elseif>
              </do_if>
              <do_if value="$ShipGroup">
                <add_to_group groupname="$ShipGroup" object="$Ship"/>
              </do_if>
			  
			<set_value name="$AddAsSubordinates" exact="false"/>
			<do_if value="$Ship.isclass.ship_l">
              <do_if value="@event.param.{4}">
                <do_all exact="event.param.{4}">
                  <create_ship name="$Follower" sector="event.param.{1}">
                    <select faction="faction.khaak" size="class.ship_s"/>
                    <owner exact="faction.khaak"/>
                    <pilot>
                      <select faction="faction.khaak" tags="tag.aipilot"/>
                    </pilot>
                    <!--TODO @Owen better spawning position for subordinates-->
                    <safepos object="$Ship"/>
                  </create_ship>
                  <do_if value="$AddAsSubordinates">
                    <set_object_commander object="$Follower" commander="$Ship"/>
                    <create_order object="$Follower" id="'Escort'" default="true">
                      <param name="formation" value="formationshape.halfcircle"/>
                      <!-- ship width -->
                      <param name="formationparam" value="32.6274m"/>
                      <param name="rollformation" value="true"/>
                      <param name="overrideformationskill" value="true"/>
                    </create_order>
                  </do_if>
                  <do_else>
                    <create_order object="$Follower" id="'Patrol'" default="true">
                      <param name="space" value="$Follower.sector"/>
                    </create_order>
                  </do_else>

                  <do_if value="$ShipGroup">
                    <add_to_group groupname="$ShipGroup" object="$Follower"/>
                  </do_if>
                </do_all>
              </do_if>
			</do_if>
			<do_else>	
				<do_if value="@event.param.{4}">
                <do_all exact="event.param.{4}">
                  <create_ship name="$Follower" sector="event.param.{1}">
                    <select faction="faction.khaak" size="class.ship_s"/>
                    <owner exact="faction.khaak"/>
                    <pilot>
                      <select faction="faction.khaak" tags="tag.aipilot"/>
                    </pilot>
                    <!--TODO @Owen better spawning position for subordinates-->
                    <safepos object="$Ship"/>
                  </create_ship>
                  <do_if value="$AddAsSubordinates">
                    <set_object_commander object="$Follower" commander="$Ship"/>
                    <create_order object="$Follower" id="'Escort'" default="true">
                      <param name="formation" value="formationshape.halfcircle"/>
                      <!-- ship width -->
                      <param name="formationparam" value="32.6274m"/>
                      <param name="rollformation" value="true"/>
                      <param name="overrideformationskill" value="true"/>
                    </create_order>
                  </do_if>
                  <do_else>
                    <create_order object="$Follower" id="'Patrol'" default="true">
                      <param name="space" value="$Follower.sector"/>
                    </create_order>
                  </do_else>

					  <do_if value="$ShipGroup">
						<add_to_group groupname="$ShipGroup" object="$Follower"/>
					  </do_if>
					</do_all>
				  </do_if>
			</do_else>			
			
			
			
              <add_effect object="$Ship.zone" effect="'jump_jumpin_khaak'">
                <position object="$Ship"/>
              </add_effect>
            </do_if>
            <do_else>
              <cancel_cue cue="this"/>
            </do_else>
          </actions>
          <delay exact="$ActivateTime"/>
          <actions>
            <do_if value="$Ship.isoperational">
              <create_cue_actor cue="this" name="$Pilot">
                <select faction="faction.khaak" tags="tag.aipilot"/>
              </create_cue_actor>
              <assign_control_entity object="$Ship" actor="$Pilot" post="controlpost.aipilot" transfer="true"/>
              <create_order object="$Ship" id="'Patrol'" default="true">
                <param name="space" value="$Ship.sector"/>
              </create_order>
            </do_if>
          </actions>
	</cue>
</replace>
</diff>